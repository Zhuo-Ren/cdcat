<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>myTitle</title>
    <!-- jquery-->
    <script src="../static/jquery-ui-1.12.1/external/jquery/jquery.js"></script>
    <!-- jquery ui-->
    <link rel="stylesheet" href="../static/jquery-ui-1.12.1/jquery-ui.css">
    <script src="../static/jquery-ui-1.12.1/jquery-ui.js"></script>
    <script src="../static/jquery-ui-1.12.1/my-ui.js"></script>
    <!-- jquery ui layout-->
	<script src="../static/jquery-layout-1.4.0/jquery.layout-latest.js"></script>
    <link rel="stylesheet" href="../static/jquery-layout-1.4.0/layout-default-latest.css">
    <script src="../static/jquery-layout-1.4.0/my-layout.js"></script>
    <link href="../static/jquery-layout-1.4.0/my-layout.css" rel="stylesheet">
    <!-- text stype -->
    <style>
        .char{
            float: left;
        }
        .textTab{
            height: 90%;
        }
        #allInstanceTab{
            padding-left: 3.2px;
            padding-right: 3.2px;
        }
        #commonInstanceTab{
            padding-left: 3.2px;
            padding-right: 3.2px;
        }
        .curSlot{
            background: red;
        }

    </style>
    <script>
        // å…¨å±€å˜é‡ã€‚array of html elementsã€‚é€‰ä¸­çš„æ–‡æœ¬æ‰€å¯¹åº”çš„å…ƒç´ çš„æ•°ç»„ã€‚
        var selectedElements = 0
        // å…¨å±€å˜é‡ã€‚è®°å½•æ­£åœ¨å¡«å……çš„å®ä¾‹æ§½ã€‚
        var curTriggerInstanceSlot = undefined;
        // å…¨å±€å˜é‡ã€‚è®°å½•è¢«é€‰ä¸­çš„å®ä¾‹ã€‚
        var curSelectedInstance = undefined;
    </script>
</head>
<body>
    <div id="centerWindow">
        <div id="textWindow">
            <ul>
                <li><a href="#textTab1">major</a></li>
                <li><a href="#textTab2">minor</a></li>
            </ul>
            <div class="ui-layout-content">
                <div id="textTab1" class="textTab">
<!--                    {% for cur_text_unit in text_unit_list %}-->
<!--                        {% if cur_text_unit["char"] in ["\n","\r"] %}-->
<!--                            <div id= {{cur_text_unit["position"]}} class="char">-->
<!--                                <div>\n</div>-->
<!--                            </div>-->
<!--                            <br style="clear:both;">-->
<!--                        {% elif cur_text_unit["char"] == " " %}-->
<!--                            <div id={{cur_text_unit["position"]}} class="char" >-->
<!--                                <div>&nbsp;</div>-->
<!--                            </div>-->
<!--                        {% else %}-->
<!--                            <div id={{cur_text_unit["position"]}} class="char" >-->
<!--                                <div>{{ cur_text_unit["char"] }}</div>-->
<!--                            </div>-->
<!--                        {% endif %}-->
<!--                    {% endfor %}-->
                </div>
                <div id="textTab2" class="textTab">
                    <p>minor window is to show a mention in mentionList of a instance.</p>
                </div>
            </div>
        </div>
        <div id="nodeInfoWindow">
            <p id="nodeInfo-noSelect" style="display: block">select a range of text to show the annotation info.</p>
            <button id="nodeInfo-noNode" style="display: none">the selected text isn't a annotation object, click this button to add a annotation object.</button>
            <div id="nodeInfo-path" style="display: none">
                <span id="pathKey"> > path =</span>
                <span id="pathValue">XXXXX</span>
            </div>
            <div id="nodeInfo-token" style="display: none">
                <span id="tokenKey"> > token =</span>
                <span id="tokenValue">
                    <input type = "radio" name = "token" value = "true" />True
                    <input type = "radio" name = "token" value = "false" checked/>False
                </span>
            </div>
            <div id="nodeInfo-semanticType" style="display: none">
                <span id="semanticTypeKey"> > ner.entity_type =</span>
                <span id="semanticTypeValue">
                    <select>
                        <option value="none" selected>æ— </option>
                        <option value="peo">äºº</option>
                        <option value="org">ç»„ç»‡</option>
                        <option value="addr">åœ°ç‚¹</option>
                        <option value="act">è¡Œä¸º</option>
                        <option value="sub">ç‰©</option>
                    </select>
                </span>
            </div>
            <div id="nodeInfo-instance" style="display: none">
                <span id="instanceKey"> > coref.instance =</span>
                <button id="instanceValue" class="instance">none</button>
                <span>(å•å‡»ï¼šæ˜¾ç¤ºå¹¶ç¼–è¾‘å®ä¾‹ä¿¡æ¯ï¼ŒåŒå‡»ï¼šé€‰æ‹©å¦ä¸€ä¸ªå®ä¾‹)</span>
            </div>
        </div>
    </div>
    <div id="instanceWindow">
        <div id="instanceSelectWindow">
            <ul>
                <li><a href="#allInstanceTab">å…¨éƒ¨å¯¹è±¡</a></li>
                <li><a href="#commonInstanceTab">å¸¸ç”¨å¯¹è±¡</a></li>
            </ul>
            <div id="allInstanceTab">
                <div id="searchInstance">
                    <input style="width: 85%">
                    <button class="searchInstanceButton" style="padding:0px;">ğŸ”</button>
                </div>
                <div id="resultInstance">
                    <button class="instance">+</button>
                    {% for i in instance_dict: %}
                        <button id={{instance_dict[i]["id"]}} class="instance" name={{instance_dict[i]["id"]}}>
                            {{instance_dict[i]["desc"]}}
                        </button>
                    {% endfor %}
                </div>
            </div>
            <div id="commonInstanceTab">
                <button class="instance">+</button>
            </div>
        </div>
        <div id="instancInfoWindow">
            <div id="instanceInfo-noInstance"style="display: block">select a instance to show it's info.</div>
            <div id="instanceInfo-id" style="display: none">
                <span id="idKey">id=</span>
                <span id="idValue"> </span>
                <hr/>
            </div>
            <div id="instanceInfo-desc" style="display: none">
                <span id="descKey">desc= </span>
                <input id="descValue" type="text" value="" />
                <hr/>
            </div>
            <div id="instanceInfo-kg"  style="display: none">
                <span id="kgKey">kg=</span>
                <input id="kgValue" type="text" value="none"/>
                <hr/>
            </div>
            <div id="instanceInfo-mentionList"  style="display: none">
                <span id="mentionListKey">mentionList=</span>
                <div id="mentionListValue">

                </div>
                <hr/>
            </div>
        </div>
    </div>
</body>

<!-- å‡½æ•°å®šä¹‰ -->
<script>
    function showText(tab, data){
        tab.empty();
        for (i=0; i<data.length; i++){
            elementText = "<div " +
                                "id=" + data[i]["position"] +
                                " " +
                                "class='char'" +
                            ">";
            if (data[i]["char"] === "\n"){
                elementText += "<div>\\n<div> <br style='clear:both;'>";
            }
            if (data[i]["char"] ==="\r"){
                elementText += "<div>\\n<div> <br style='clear:both;'>";
            }
            if (data[i]["char"] === " "){
                elementText += "<div>&nbsp; <div>";
            }
            else{
                elementText += "<div>" + data[i]["char"] + "<div>";
            }
            elementText += "</div>";
            //
            tab.append($(elementText));
        }
    }
    function loadText(tabSelector, textNodeId){
        var tab = $(tabSelector);
        $.post(
            "/getText",
            {
                textNodeId: textNodeId
            },
            function (data, status) {
                showText(tab, data)
            }
        );
    }

    function showNoSelect(){
        $("#nodeInfo-noSelect").css("display", "block");
        $("#nodeInfo-noNode").css("display", "none");
        $("#nodeInfo-path").css("display", "none");
        $("#nodeInfo-token").css("display", "none");
        $("#nodeInfo-semanticType").css("display", "none");
        $("#nodeInfo-instance").css("display", "none");
    }
    function showNoNodeInfo(){
        $("#nodeInfo-noSelect").css("display", "none");
        $("#nodeInfo-noNode").css("display", "block");
        $("#nodeInfo-path").css("display", "none");
        $("#nodeInfo-token").css("display", "none");
        $("#nodeInfo-semanticType").css("display", "none");
        $("#nodeInfo-instance").css("display", "none");
    }
    function showNodeInfo(nodeInfo) {
        if(nodeInfo["position"]){
            $("#pathValue")[0].textContent = nodeInfo["position"]
        }else{
            $("#pathValue")[0].textContent = ""
        }
        if(nodeInfo["token"]){
            $("#tokenValue").children()[0].checked = true
        }else{
            $("#tokenValue").children()[1].checked = true
        }
        if(nodeInfo["semanticType"]){
            $("#semanticTypeValue option[value="+ nodeInfo["semanticType"] +"]")[0].selected = true
        }else{
            $("#semanticTypeValue option[value='none']")[0].selected = true
        }
        if(nodeInfo["instance"]){
            $("#instanceValue")[0].textContent = nodeInfo["instance"]["desc"];
            $("#instanceValue")[0].name = nodeInfo["instance"]["id"];
        }else{
            $("#instanceValue").textContent = "æ— ";
            $("#instanceValue").name = -1;
        }
        $("#nodeInfo-noSelect").css("display", "none");
        $("#nodeInfo-noNode").css("display", "none");
        $("#nodeInfo-path").css("display", "block");
        $("#nodeInfo-token").css("display", "block");
        $("#nodeInfo-semanticType").css("display", "block");
        $("#nodeInfo-instance").css("display", "block");
    }
    function showCannotAddNodeInfo(){
        alert("ä¸è¡Œ")
    }
    function getNodeByPosition(){}
    function getNodeByChildren(startNodePosition, endNodePosition){
        $.post(
            "/getNode",
            {
                start: startNodePosition,
                end: endNodePosition
            },
            function (data, status) {
                // åŒºåˆ†æ˜¯å¦ä¸ºæ ‡æ³¨å¯¹è±¡
                if (data === "") {
                    showNoNodeInfo();
                } else {
                    showNodeInfo(data);
                }
            }
        );
    }
    function setNode(position, infoDict){
        infoDict["position"] = position;
        $.post(
            "/setNode", infoDict,
            function (data, status) {
                showNodeInfo(data);
            }
        )
    }
    function addNodeByChildren(childrenNodePositionList){
        $.post(
            "/addNode",
            {
                childrenNodePositionList: childrenNodePositionList
            },
            function (data, status) {
                // åŒºåˆ†æ˜¯å¦ä¸ºæ ‡æ³¨å¯¹è±¡
                if (data === ""){
                    showCannotAddNodeInfo();
                }else{
                    // æ˜¾ç¤ºæ ‡æ³¨ä¿¡æ¯
                    showNodeInfo(data);
                    // é‡æ–°åŠ è½½æ–‡æœ¬
                    loadText("#textTab1", "")
                }
            }
        );
    }

    function showInstanceInfo(data){
        $("#idValue").text(data["id"]);
        $("#descValue").val(data["desc"]);
        if(data["kg"] !== undefined){
            $("#kgValue").val(data["kg"])
        }
        var mentionListValue = $("#mentionListValue");
        mentionListValue.empty();
        for(var i=0;i<data["mention_list"].length;i++){
            var curMention = data["mention_list"][i];
            var curMentionLine = $("<div></div>");
            curMentionLine.append($("<span>[</span>"));
            for (var j=0; j<curMention.length; j++){
                var curPart = curMention[j];
                curMentionLine.append($(
                    "<button" +
                        " name=\"" + curPart["position"]+ "\"" +
                    ">" +
                        curPart["text"] +
                    "</button>"
                ))
            }
            curMentionLine.append($("<button>+</button>"));
            curMentionLine.append($("<span>]</span>"));
            mentionListValue.append(curMentionLine)
        }
        mentionListValue.append($("<button>+</button>"));
        //
        $("#instanceInfo-noInstance").css("display", "none");
        $("#instanceInfo-id").css("display", "block");
        $("#instanceInfo-desc").css("display", "block");
        $("#instanceInfo-kg").css("display", "block");
        $("#instanceInfo-mentionList").css("display", "block");
    }
    function getInstanceById(id){
        $.post(
            "/getInstance",
            {instance_id: id},
            function (data, status) {
                showInstanceInfo(data)
            }
        );
    }
    function setInstance(id, infoDict){
        infoDict["id"] = id;
        $.post(
            "/setNode", infoDict,
            function (data, status) {
                getInstanceById(data);
            }
        )
    }
    function addInstance(){}

    function startOfInstanceSlotFilling(){
        // æ ‡çº¢å½“å‰æ§½å…ƒç´ 
        curTriggerInstanceSlot.classList.add("curSlot");
        document.body.style.cursor = "help";
    }
    function endOfInstanceSlotFilling(){
        // æ•°æ®å‡†å¤‡
        var slot = curTriggerInstanceSlot;
        if (slot.parentElement.parentElement.getAttribute("id") === "nodeInfoWindow"){
            var slotType = "node";
            var position = $("#pathValue").text();
        }
        newInstanceId = curSelectedInstance.name;
        // å‘åå°ä¼ æ•°æ®
        if (slotType === "node"){
            setNode(position,{"instance":newInstanceId});
        } else if (slotType === "instance"){
            setInstance()
        }
        // å–æ¶ˆå½“å‰soltçš„å¾…é€‰ç‰¹æ•ˆ
        curTriggerInstanceSlot.classList.remove("curSlot");
        document.body.style.cursor = "";
        //
        curTriggerInstanceSlot = undefined
    }


</script>

<!-- äº‹ä»¶å¥æŸ„ -->
<script>
    // é€‰ä¸­ä¸€æ®µæ–‡æœ¬
    function textMouseup() {
        // æ¸…é™¤ä¸Šæ¬¡çš„é€‰åŒºæ•ˆæœ
        if (selectedElements !== 0) {
            for (var i = 0; i < selectedElements.length; i++) {
                selectedElements[i].style = "color: black";
            }
        }
        // å¦‚æœæ²¡é€‰ä¸­ä»»ä½•å†…å®¹
        if (window.getSelection().toString() === "") {
            showNoSelect()
        }
        // å¦‚æœé€‰ä¸­äº†æŸäº›å†…å®¹
        else {
            // è·å–å½“å‰é€‰åŒº(å¦‚æœæœ‰å¤šä¸ªé€‰å–ï¼Œé‚£åªç®¡ç¬¬ä¸€ä¸ª)
                var selected = window.getSelection();
                var curRange = selected.getRangeAt(0);
                // è·å–anchor
                var startDiv = curRange.startContainer.parentNode;
                if (startDiv.className.indexOf("ui-layout-content") !== -1) {
                    startDiv = startDiv.children[0].children[0]
                } else if (startDiv.className.indexOf("textTab") !== -1) {
                    startDiv = startDiv.childNodes[0]
                } else if (startDiv.className.indexOf("char") !== -1) {
                    //
                } else if (startDiv.id === "") {
                    startDiv = startDiv.parentNode;
                } else if (startDiv.id === undefined) {
                    startDiv = startDiv.parentNode.parentNode
                } else {
                    alert("è·å–æ–‡æœ¬é€‰åŒºçš„anchorå…ƒç´ å‡ºé”™")
                }
                // è·å–curve
                var endDiv = curRange.endContainer.parentNode;
                if (endDiv.className.indexOf("ui-layout-content") !== -1) {
                    endDiv = endDiv.children[0].children[0]
                } else if (endDiv.className.indexOf("textTab") !== -1) {
                    endDiv = endDiv.childNodes[0]
                } else if (endDiv.className.indexOf("char") !== -1) {
                    //
                } else if (endDiv.id === "") {
                    endDiv = endDiv.parentNode;
                } else if (endDiv.id === undefined) {
                    endDiv = endDiv.parentNode.parentNode
                } else {
                    alert("è·å–æ–‡æœ¬é€‰åŒºçš„curveå…ƒç´ å‡ºé”™")
                }
                // è¯†åˆ«anchorå’Œcurveçš„é¡ºåºï¼Œå¾—åˆ°startå’Œend
                if (startDiv.id > endDiv.id) {
                    t = endDiv;
                    endDiv = startDiv;
                    startDiv = t;
                }
                // éå†é€‰åŒºï¼Œå¾—åˆ°elementåˆ—è¡¨
                selectedElements = new Array(0);
                var selectedText = "";
                var curDiv = startDiv;
                while (true) {
                    selectedElements.push(curDiv);
                    selectedText = selectedText + curDiv.childNodes[0].textContent;
                    if (curDiv !== endDiv) {
                        curDiv = curDiv.nextElementSibling;
                    } else {
                        break;
                    }
                }
                // è§£å†³startå’Œendçš„ç©ºé€‰é—®é¢˜
                s = selected.toString().replace(/[\n\r]/g, "")
                if (s[0] !== selectedText[0]) {
                    selectedElements.shift();
                    selectedText = selectedText.slice(1, selectedText.length);
                }
                if (s[s.length - 1] !== selectedText[selectedText.length - 1]) {
                    selectedElements.pop();
                    selectedText = selectedText.slice(0, selectedText.length - 1);
                }
            // é€‰ä¸­æ•ˆæœ
                for (var i = 0; i < selectedElements.length; i++) {
                    selectedElements[i].style = "color: red";
                }
                selected.empty();
            // è¯·æ±‚æ³¨é‡Šä¿¡æ¯ï¼Œå¹¶æ˜¾ç¤º
                getNodeByChildren(
                    selectedElements[0].id.toString(),
                    selectedElements[selectedElements.length - 1].id.toString()
                )
        }
    }
    // å•å‡»â€œæ·»åŠ æ ‡æ³¨å¯¹è±¡â€æŒ‰é’®
    function addNodeButtonClick(){
        if(selectedElements !== 0){
            // è·å–é€‰ä¸­çš„nodeçš„position listã€‚
            var selectedElementsIdList = Array();
            for (i=0; i<selectedElements.length; i++){
                selectedElementsIdList[i] = selectedElements[i].id.toString()
            }
            // å‘åå°å‘é€æ“ä½œè¯·æ±‚
            addNodeByChildren(selectedElementsIdList)
        }
    }
    // å•å‡»å®ä¾‹
    function instanceClick(){
        if (curTriggerInstanceSlot === undefined){
            // æ˜¾ç¤ºå®ä¾‹ä¿¡æ¯
            getInstanceById(curSelectedInstance.name);
        }
        else{
            // é€‰æ‹©æ­¤å®ä¾‹å¡«å……å½“å‰æ§½
            endOfInstanceSlotFilling();
        }
    }
    // åŒå‡»å®ä¾‹
    function instanceDblclick(triggerElement){
        startOfInstanceSlotFilling()
    }
    // èŠ‚ç‚¹ä¿¡æ¯å˜åŠ¨ï¼ˆtokenï¼‰
    function nodeTokenChange(){
        var position = $("#pathValue").text();
        var tokenValue = $("#tokenValue :checked").attr("value");
        if (tokenValue === "false"){
            tokenValue = false;
        }else if(tokenValue === "true"){
            tokenValue = true;
        }else{
            alert("æç¬‘")
        }
        setNode(position, {"token": tokenValue});
    }
    // èŠ‚ç‚¹ä¿¡æ¯å˜åŠ¨ï¼ˆsemanticTypeï¼‰
    function nodeSemanticTypeChange(){
        var position = $("#pathValue").text();
        var semanticTypeValue = $("#semanticTypeValue :checked").attr("value");
        setNode(position, {"semanticType": semanticTypeValue});
    }
    // å®ä¾‹ä¿¡æ¯å˜åŠ¨(desc)
    function instanceDescChange(){
        var id = $("#idValue").text()
        var descValue = $("#descValue")[0].value
        setInstance(id, {"desc": descValue})
    }
    // å®ä¾‹ä¿¡æ¯å˜åŠ¨(kg)
    function instanceKgChange(){
        var id = $("#idValue").text()
        var kgValue = $("#kgValue")[0].value
        setInstance(id, {"kg": kgValue})
    }
</script>

<!-- ç»‘å®šäº‹ä»¶ -->
<script>
    // åŠ è½½æ–‡æœ¬
    loadText("#textTab1", "")
    // é€‰ä¸­ä¸€æ®µæ–‡æœ¬
    $(".textTab").mouseup(function(){textMouseup();})
    // å•å‡»â€œæ·»åŠ æ ‡æ³¨å¯¹è±¡â€æŒ‰é’®
    $("#nodeInfo-noNode").click(function(){addNodeButtonClick()})
    // ç”¨äºå•å‡»å®ä¾‹å’ŒåŒå‡»å®ä¾‹çš„è®¡æ—¶å™¨
    var clickFlag = null;
    // å•å‡»å®ä¾‹
    $(".instance").click(function(){
        if(clickFlag) {//å–æ¶ˆä¸Šæ¬¡å»¶æ—¶æœªæ‰§è¡Œçš„æ–¹æ³•
            clickFlag = clearTimeout(clickFlag);
        }
        curSelectedInstance = this;
        clickFlag = setTimeout(function(){
            instanceClick()
        }, 150);//å»¶æ—¶300æ¯«ç§’æ‰§è¡Œ
    })
    // åŒå‡»å®ä¾‹
    $("#instanceValue").dblclick(function(){
        if(clickFlag) {//å–æ¶ˆä¸Šæ¬¡å»¶æ—¶æœªæ‰§è¡Œçš„æ–¹æ³•
            clickFlag = clearTimeout(clickFlag);
        }
        // dblclick äº‹ä»¶çš„å¤„ç†
        if (curTriggerInstanceSlot === undefined){
            curTriggerInstanceSlot = this;
            instanceDblclick();
        }
    })
    // æ ‡æ³¨ä¿¡æ¯å˜åŠ¨ï¼ˆtokenï¼‰
    $("#tokenValue input").change(function(){nodeTokenChange();})
    // æ ‡æ³¨ä¿¡æ¯å˜åŠ¨ï¼ˆsemanticTypeï¼‰
    $("#semanticTypeValue select").change(function(){nodeSemanticTypeChange();})
    // å®ä¾‹ä¿¡æ¯å˜åŠ¨(desc)
    $("#descValue").change(function(){instanceDescChange();})
    // å®ä¾‹ä¿¡æ¯å˜åŠ¨(kg)
    $("#kgValue").change(function(){instanceKgChange();})
</script>

</html>

